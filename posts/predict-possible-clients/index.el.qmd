---
title: "Εντοπίζοντας πιθανούς ενδιαφερόμενους πελάτες"
author: "stesiam"
description: |
  Κατασκευή μοντέλων μηχανικής μάθησης (χρησιμοποιώντας LightGBM & XGBoost) με σκοπό την ταξινόμηση των ανθρώπων με βάση το ενδεχόμενο ενδιαφέρον τους να δημιουργήσουν ένα τραπεζικό λογαριασμό προσθεσμιακής κατάθεσης.
freeze: false
link-external-newwindow: true
categories: [R, Ταξινόμηση, Tidymodels]
image: client_predict.png
image-alt: Ένας μεγεθυντικός φακός που δείχνει κάποιες φιγούρες ανθρώπων
fig-cap-location: bottom
date: "2022-11-24"
toc: true
toc-title: Περιεχόμενα
toc-location: left
citation: true
title-block-banner: true
nocite: '@*'
csl: apa-6th-edition.csl
bibliography: [packages.bib, references.bib]
format: 
  html:
    freeze: false
    code-link: true
    code-fold: true
    code-summary: "Δείξε τον κώδικα"
    code-tools: 
      source: https://github.com/stesiam/stesiam.github.io/blob/gh-pages/posts/predict-possible-clients/index.el.qmd
execute:
  echo: true
editor_options: 
  markdown: 
    wrap: 80
---

## Εισαγωγή

Σε αυτό το άρθρο θα κατασκευάσω ένα μοντέλο μηχανικής μάθησης για να προβλέψω
ποιοι από τους πελάτες μίας τράπεζας ενδιαφέρονται να ανοίξουν έναν λογαριασμό
προθεσμικής κατάθεσης. Για το σκοπό αυτό θα χρησιμοποιήσουμε μοντέλα Boosting
(XGBoost και LightGBM) για να ταξινομήσουμε τις περιπτώσεις πιθανές αποκρίσεις
σε ενδιαφερόμενους και μη ενδιαφερόμενους. Τα δεδομένα προέρχονται από την
ιστοσελίδα «UCI Machine Learning Repository» [@Dua2019] και χρησιμοποίησα τη
βάση δεδομένων που τιτλοφορείται ως [Bank
Marketing](https://archive.ics.uci.edu/dataset/222/bank+marketing)
[@moro2014data].

Πριν ξεκινήσουμε την ανάλυσή μας, ας κάνουμε μία νύξη σε κάποιους βασικούς
όρους.

> Τι είναι η προθεσμιακή κατάθεση;

Όταν θέλουμε να καταθέσουμε χρήματα στη τράπεζα συνήθως οι περισσότεροι έχουν
έναν απλό λογαριασμό ταμιευτηρίου ή αποταμίευσης. Ένα διαφορετικό είδος
λογαριασμού είναι ο προθεσμιακός, όπου σε αυτή τη περίπτωση δεσμεύεται ο πελάτης
της τράπεζας ότι δεν θα κάνει ανάληψη στον λογαριασμό για ένα προκαθορισμένο
χρονικό διάστημα (π.χ. για ένα έτος δεν θα κάνει ανάληψη).

> Και για ποιο λόγο να επιλέξουμε έναν τέτοιο λογαριασμό;

Είναι προφανές ότι οι προθεσμιακές καταθέσεις έχουν ένα βασικό μειονέκτημα
έναντι των τυπικών λογαριασμών σε όρους πρόσβασης στα κεφάλαιά μας. Φυσικά,
κανένας δεν θα έκανε κάποια τέτοια κίνηση αν δεν έχει κάποιο αντάλλαγμα. Έτσι
λοιπόν οι τράπεζες συνήθως σε αυτά τα προγράμματα προσφέρουν υψηλότερα επιτόκια
σε σχέση με αυτά των λογαριασμών ταμιευτηρίου / αποταμίευσης. Αξίζει να δώσουμε
μερικά παραδείγματα τραπεζών, συγκρίνοντας τα τραπεζικά επιτόκια των τυπικών και
προθεσμιακών λογιαριασμών.

-   Η Πειραιώς, μία εκ των συστημικών τραπεζών της χώρας μας, προσφέρει διπλάσιο
    επιτόκιο στους προθεσμιακούς λογαριασμούς της.

-   Η Eurobank, προσφέρει μηδενικό επιτόκιο σε λογαριασμούς ταμιευτηρίου, 0.01%
    μέχρι και 0.35% σε λογαριασμού αποταμίευσης και στις προθεσμιακές ποικίλει
    αναλόγως του προγράμματος και του ύψους της κατάθεσης από 0.1% μέχρι και 1%.

-   Γενικότερα, σύμφωνα με την πρόσφατη έκθεση της Τράπεζας της Ελλάδας, τα
    επιτόκια των προθεσμιακών κυμαίνονται από 1.2% με 1.4%, ενώ οι τυπικοί
    λογαριασμοί για τα νοικοκυριά είναι στο 0.03%.

Με βάση τα παραπάνω μπορούμε να υποθέσουμε ότι δεν θα είναι όλοι κατάλληλοι για
αυτά τα προϊόντα. Με βάση τη λογική, το κατάλληλο προφίλ των ατ κατάλληλο προφίλ
των ατόμων που να βρεθούν άτομα με σημαντικό ύψος καταθέσεων και να μην έχουν
άλλα σημαντικά βάρη, όπως δάνεια ή χρέη σε τρίτους.

## Προαπαιτούμενα

### Εισαγωγή βιβλιοθηκών

Για αυτή την ανάλυση θα χρειαστούμε τυπικές βιβλιοθήκες της R για την εισαγωγή
των δεδομένων, μέσω του readr πακέτου [@R-readr], και τη μορφοποίηση αυτών με το
dplyr πακέτο [@R-dplyr]. Το kableExtra πακέτο [@R-kableExtra] αποτελεί σημαντική
προσθήκη ώστε να τυπώσω τα αποτελέσματά μου σε μία μορφή πίνακα. Ένα σημαντικό
κομμάτι που θα πρέπει να αποφασίσω πώς να λύσω είναι αυτό της οπτικοποίησης των
δεδομένων. Αρχικά χρησιμοποιούσα το πακέτο ggplot2 προκειμένου να δημιουργήσω τα
όποια διαγράμματα, πράγμα που είναι αρκετά περιοριστικό για μία ιστοσελίδα καθώς
το ggplot2 δημιουργεί στατικά διαγράμματα. Έτσι λοιπόν για τα άρθρα μου
χρησιμοποιώ το πακέτο highcharter [@R-highcharter] όπου είναι ένα R πακέτο που
δίνει τη δυνατότητα διαγραμμάτων φιλικό για όλους τους τύπους των οθονών. Τέλος,
αυτή η ανάλυση έχει ως στόχο να ταξινομήσει τους πελάτες της τράπεζας, επομένως
θα κατασκευάσω ένα μοντέλο ταξινόμησης, και η χρήση του πακέτου tidymodels
[@R-tidymodels] κρίνεται απαραίτητη.

```{r}
#| label: import_r_libs
#| title: "Εισαγωγή R βιβλιοθηκών"
#| lst-cap: "Έτσι λοιπόν για τα άρθρα μου χρησιμοποιώ το πακέτο highcharter [@R-highcharter] όπου είναι ένα R πακέτο που δίνει τη δυνατότητα διαγραμμάτων φιλικό για όλους τους τύπους των οθονών. Τέλος, αυτή η ανάλυση έχει ως στόχο να ταξινομήσει τους πελάτες της τράπεζας, επομένως"
#| lst-cap-location: margin
#| message: false
#| results: hide
#| collapse: true

library(readr)
library(dplyr)
library(forcats)
library(kableExtra)
library(highcharter)
library(glue)
library(reactable)

# Build ML models

library(tidymodels)
library(bonsai)
library(themis)
```

```{r}
#| label: further_settings
#| title: "Εισάγω βιβλιογραφία από φορτωμένα πακέτα"
#| include: false

options(digits=4) # print only 4 decimals
options(warn = -1)

knitr::write_bib(.packages(), file = 'packages.bib')
```

### Εισαγωγή δεδομένων

Αφού φορτώσουμε τις αναγκαίες βιβλιοθήκες, θα φορτώσουμε τα δεδομένα μας. Η βάση
των δεδομένων μου έχει αρκετές εκδόσεις των ίδιων δεδομένων, μία μεγαλύτερη και
μία πιο συνοπτική έκδοση, η διαφορά τους έγκειται μόνο στον αριθμό των
παρατηρήσεων. Για το συγκεκριμένο άρθρο θα επιλέξω τη πιο συνοπτική μορφή μιας
και η προσαρμογή Boosting μοντέλων είναι αρκετά χρονοβόρα σε σύγκριση με τη
κατασκευή πιο απλώς μοντέλων ταξινόμησης (π.χ. Λογιστική Παλινδρόμηση, k
Πλησιέστερων Γειτόνων).

```{r}
#| label: import_dataset
#| title: "Εισαγωγή συνόλου δεδομένων"
#| message: false
#| results: hide
#| echo: true

bank_dataset <- read_delim("bank_dataset_files/bank.csv",  
                           delim = ";", 
                           escape_double = FALSE, 
                           trim_ws = TRUE)

bank_dataset = bank_dataset %>% tibble::rowid_to_column("ID")
```

### Προεπισκόπηση δεδομένων

Here we can see a small chunk of my dataset (first 10 rows / observations) just
to understand the dataset's structure and type of variables.

```{r}
#| label: recoding_vars
#| title: "Ανακωδικοποίηση μεταβλητών"
#| echo: false

bank_dataset$job <- bank_dataset$job |>
  fct_recode(
    "διοικητική εργασία" = "admin.",
    "χειρονακτική εργασία" = "blue-collar",
    "επιχειρηματίας" = "entrepreneur",
    "οικιακός βοηθός" = "housemaid",
    "διευθυντικό στέλεχος" = "management",
    "συνταξιούχος" = "retired",
    "αυτοαπασχολούμενος" = "self-employed",
    "παροχή υπηρεσιών" = "services",
    "σπουδαστής" = "student",
    "τεχνικός" = "technician",
    "άνεργος" = "unemployed",
    "άγνωστο" = "unknown"
  )

## Recoding bank_dataset$marital
bank_dataset$marital <- bank_dataset$marital |>
  fct_recode(
    "διαζευγμένο" = "divorced",
    "παντρεμένο" = "married",
    "ανύπαντρο" = "single"
  )

## Recoding bank_dataset$education into bank_dataset$education_
bank_dataset$education <- bank_dataset$education |>
  fct_recode(
    "πρωτοβάθμια" = "primary",
    "δευτεροβάθμια" = "secondary",
    "τριτοβάθμια" = "tertiary",
    "άγνωστο" = "unknown"
  )

## Recoding bank_dataset$default
bank_dataset$default <- bank_dataset$default |>
  fct_recode(
    "όχι" = "no",
    "ναι" = "yes"
  )

## Recoding bank_dataset$housing into bank_dataset$housing_
bank_dataset$housing <- bank_dataset$housing |>
  fct_recode(
    "όχι" = "no",
    "ναι" = "yes"
  )

## Recoding bank_dataset$loan
bank_dataset$loan <- bank_dataset$loan |>
  fct_recode(
    "όχι" = "no",
    "ναι" = "yes"
  )

## Recoding bank_dataset$contact
bank_dataset$contact <- bank_dataset$contact |>
  fct_recode(
    "σταθερό" = "cellular",
    "κινητό" = "telephone",
    "άγνωστο" = "unknown"
  )

## Recoding bank_dataset$month
bank_dataset$month <- bank_dataset$month |>
  fct_recode(
    "Απρίλιο" = "apr",
    "Αύγουστο" = "aug",
    "Δεκέμβριο" = "dec",
    "Φεβρουάριο" = "feb",
    "Ιανουάριο" = "jan",
    "Ιούλιο" = "jul",
    "Ιούνιο" = "jun",
    "Μάρτιο" = "mar",
    "Μάιο" = "may",
    "Νοέμβριο" = "nov",
    "Οκτώβριος" = "oct",
    "Σεπτέμβριος" = "sep"
  )

## Recoding bank_dataset$poutcome
bank_dataset$poutcome <- bank_dataset$poutcome |>
  fct_recode(
    "αποτυχία" = "failure",
    "άλλο" = "other",
    "επιτυχία" = "success",
    "άγνωστο" = "unknown"
  )

bank_dataset$y <- bank_dataset$y |>
  fct_recode(
    "όχι" = "no",
    "ναι" = "yes"
  )
```

```{r}
#| label: tbl-preview-dataset
#| title: "Προεπισκόπηση δεδομένων"
#| tbl-cap: "Προεπισκόπηση δεδομένων (πρώτες 6 παρατηρήσεις)"
#| tbl-cap-location: top

preview_bank_dataset = head(bank_dataset, 6)
reactable(
  preview_bank_dataset,
  bordered = FALSE,     # No borders (booktabs style)
  striped = FALSE,      # No stripes for a clean look
  highlight = FALSE,    # No hover highlighting
  defaultColDef = colDef(align = "center"),
  style = list(fontSize = "14px", border = "none"),
  theme = reactableTheme(
    borderColor = "transparent", # Remove border
    cellStyle = list(
      borderBottom = "transparent"  # Subtle line between rows
    ),
    headerStyle = list(
      borderBottom = "2px solid rgb(117, 117, 117)", # Thick top rule
      borderTop = "2px solid rgb(117, 117, 117)",
      fontWeight = "bold"
    )
  )
)
```

Προτού κάνουμε οποιαδήποτε ανάλυση είναι καλό να προσδιορίσουμε το τύπο των
δεδομένων που έχουμε διαθέσιμα. Ως επί το πλεείστον αυτό μπορούμε να το μάθουμε
κοιτώντας τις τιμές που λαμβάνει μία μεταβλητή. Γενικότερα, οι μεταβλητές
μπορούν να ταξινομηθούν με βάση τις τιμές που λαμβάνουν ως εξής:

<center>

```{mermaid}
%%| echo: false
%%| label: fig-diagram-var-types
%%| title: "Απλό διάγραμμα για τους τύπους των μεταβλητών"
%%| fig-cap: Κατηγοριοποίηση μεταβλητής με βάση τις τιμές της
graph TD;
  A(Τύπος μεταβλητών) --> B(Ποσοτική)
  A(Τύπος μεταβλητών) --> C(Ποιοτική)
  B --> D(Διακριτή)
  B --> E(Συνεχής)
  C --> J(Κατηγορική)
  C --> G(Διατάξιμη)
```

</center>

| Μεταβλητή | Τύπος μεταβλητής | Περιγραφή |
|:-------------------------:|:-------------------------:|:-------------------------:|
| `Age` | *ποσοτική* <br> (συνεχής) | Ηλικία ατόμου |
| `Job` | *ποιοτική* <br> (κατηγορική) | Κλάδος απασχόλησης ατόμου |
| `Marital` | *ποιοτική* <br> (κατηγορική) | Οικογενειακή κατάσ |
| `Education` | *ποιοτική* <br> (διατάξιμη) | Υψηλότερη βαθμίδα εκπαίδευσης |
| `Default` | *ποιοτική* <br> (κατηγορική) | has credit in default? |
| `Balance` | *ποσοτική* <br> (συνεχής) | Average yearly balance, in euros |
| `Housing` | *ποιοτική* <br> (κατηγορική) | Έχει στεγαστικό δάνειο; |
| `Loan` | *ποιοτική* <br> (κατηγορική) | Έχει προσωπικό δάνειο; |
| `Contact` | *ποιοτική* <br> (κατηγορική) | Μέσο επικοινωνίας |
| `Month` | *ποιοτική* <br> (διατάξιμη) | Μήνας πιο πρόσφατης προσέγγισης |
| `Duration` | *ποσοτική* <br> (continuous) | Διάρκεια (σε δευτερόλεπτα) τελευταίας επικοινωνίας |
| `Campaign` | *quantitative* | Αριθμός προσεγγίσεων σε ένα άτομο |
| `pdays` | *quantitative* | Αριθμός ημερών που μεσολάβησαν από τελευταία ενημέρωση |
| `pprevious` | *quantitative* | Αριθμός προσεγγίσεων του πελάτη |
| `poutcome` | *qualitative* (nominal) | Αποτέλεσμα πορηγούμενης προωθητικής καμπάνιας |
| `Deposit` | *qualitative* <br> (nominal) | Has the client subscribed a term deposit? |

: Σύνοψη μεταβλητών δεδομένων {#tbl-preview-dataset1}

Το δείγμα μου αποτελείται από `r ncol(bank_dataset)` μεταβλητές (στήλες), εκ των
οποίων οι 7 είναι ποσοτικές και οι υπόλοιπες 10 ποιοτικές. Όσον αφορά τις
ποιοτικές μεταβλητές, 8 από αυτές είναι κατηγορικές και μόλις δύο είναι
διατάξιμες (Μήνας προώθησης και Επίπεδο εκπαίδευσης).

### Ορισμός συναρτήσεων

> Οκ, είδαμε κάποια βασικά στοιχεία των δεδομένων μου και τη δομή αυτών. Μπορώ
> τώρα να ξεκινήσω την ανάλυσή μου;

Εξαρτάται. Σε περίπτωση που θέλεις να πάρεις μία γρήγορη ανάλυση προκειμένου να
λάβεις ένα συκγκεκριμένο αποτέλεσμα πιθανότατα να είναι εντάξει. Βέβαια, τις
περισσότερες φορές απαιτείται προσεκτικότερος σχεδιασμός της μελέτης. Ένας
αρκετά συχνό λάθος στο οποίο έχω υποπέσει και εγώ στο παρελθόν είναι ο κίνδυνος
της επαναληψιμότητας ορισμένων διαδικασιών. Προκειμένου να αποτρέψουμε να
γράφουμε τα ίδια πράγματα πολλές φορές κρίνεται απαραίτητη η συγγραφή ορισμένων
συναρτήσεων. Για παράδειγμα στη συγκεκριμένη άσκηση παρατηρώ ότι έχω αρκετές
μεταβλητές του ίδιου τύπου, τόσο ποιοτικές όσο και ποσοτικές. Για ποιο λόγο
λοιπόν να γράψω 10 φορές παρόμοιο κώδικα όταν μπορώ να εσωκλείσω τα βασικά
χαρακτηριστικά σε μία συνάρτηση.

Έτσι λοιπόν έχω ορίσει δύο μεταβλητές. Αρχικά την `univariateQualitativePlot` η
οποία χρησιμοποιείται για τη κατασκευή κυκλικών διαγραμμάτων για τις ποιοτικές
μεταβλητές μου.

```{r}
#| label: function_qualitative_plots
#| title: "Συνάρτηση: Δημιουργία διαγράμματος για μία ποιοτική μεταβλητή"
univariateQualitativePlot <- function(data, column, title, subtitle, chart_type = "bar") {

  # Compute frequency table
  freq_table <- data %>%
    count({{ column }}, name = "Frequency") %>%
    arrange(desc(Frequency)) %>%
    rename(Variable = {{ column }}) %>%
    mutate(pct = round((Frequency / sum(Frequency) *100), digits = 1))

  # Define common chart properties
  hc <- highchart() %>%
    hc_title(text = title) %>%
    hc_subtitle(text = subtitle) %>%
    hc_tooltip(pointFormat = "{point.name}: {point.y}") %>%
    hc_legend(enabled = chart_type == "pie")  # Enable legend only for pie chart

  # Choose chart type
  hc <- if (chart_type == "bar") {
    hc %>%
      hc_chart(type = "bar") %>%
      hc_xAxis(categories = freq_table$Variable, title = list(text = "Job Category")) %>%
      hc_yAxis(title = list(text = "Frequency")) %>%
      hc_series(list(name = "Frequency", data = freq_table$Frequency))
  } else if (chart_type == "pie") {
    pie_data <- lapply(1:nrow(freq_table), function(i) {
      list(name = freq_table$Variable[i], y = freq_table$Frequency[i])
    })
    
    hc %>%
      hc_chart(type = "pie") %>%
      hc_series(list(name = "Frequency", data = pie_data))
  } else {
    stop("Invalid chart type. Use 'bar' or 'pie'.")
  }

  return(hc)
}
```

Αντίστοιχα, θα ορίσω και τη συνάρτηση `univariateQuantitativePlot` για τη
κατασκευή ραβδογραμμάτων για τις ποσοτικές μεταβλητές μου. Και οι δύο
συναρτήσεις βασίζονται και κατασκευάσουν διαγράμματα χρησιμοποιώντας το πακέτο
highcharter.

## Περιγραφική Ανάλυση

### Ελλειπούσες τιμές

```{r}
#| label: missing_values
#| title: "Έλεγχος ελλειπουσών τιμών"
#| results: hide
how_many_nas = sum(is.na(bank_dataset))
```

Στα δοσμένα δεδομένα υπάρχουν συνολικά `r how_many_nas` ελλειπούσες τιμές. Αυτή
βέβαια είναι μία σπάνια - ιδανική περίπτωση. Σε διαφορετική περίπτωση θα έπρεπε
να γεμίσουμε τις κενές τιμές με κάποια μέθοδο εκτίμησης.

### Μονομεταβλητή ανάλυση

Στη συνέχεια είναι σημαντικό να μελετήσουμε τις μεταβλητές μου, τις τιμές τους και τις κατανομές αυτών. Είναι ένα σημαντικό κομμάτι ώστε να κατανοήσω το δείγμα και να λάβω παραπάνω παραμέτρους υπόψιν μου στη κατασκευή του μοντέλου. 

Όσον αφορά τον κλάδο της εργασίας, στο δείγμα παρατηρείται μία σημαντική συμμετοχή ατόμων με εργασίες που πιθανότατα συνδυάζονται με υψηλότερες σπουδές και συνεπακόλουθα υψηλότερες απολαβές, όπως τα διευθυντικά στελέχη, διοικητικοί υπάλληλοι, επιχειρηματίες κτλ. Περίπου το 40% των πελατών της τράπεζας απασχολούνται σε εργασίες μπλέ κολάρου οι οποίες τις περισσότερες φορές να συνδυάζονται με και να δημιουργήσει μη επιθυμία δέσμευσης σε ένα τραπεζικό προϊόν που θα δεσμεύει χρηματικό κεφάλαιο. Τέλος, στο πελατολόγιο της τράπεζας ένα ποσοστό περί το 10% που αποτελείται από ομάδες πληθυσμού που για διάφορους λόγους δεν τους συμφέρει να δημιουργήσουν ένα τέτοιο λογαριασμό, όπως οι άνεργοι, οι σπουδαστές μιας και βρίσκονται σε ευάλωτη περίοδο με αυξημένα έξοδα και περιορισμένες πηγές εισοδήματος καθώς και οι συνταξιούχοι μιας και θα χρειαστούν να καλύψουν έκτακτες ανάγκες σε παροχές υγείας. Ειδικά για τους τελευταίους που αποτελούν το 5% των πελατών της τράπεζας, υπάρχουν άλλα χρηματοδοτικά εργαλεία αν θέλουν να εξασφαλίσουν τα γηρατειά τους, όπως τα αντίστροφα στεγαστικά δάνεια.

```{r}
#| label: fig-job
#| title: "Διάγραμμα: Κλάδος απασχόλησης"
#| fig-align: center
#| fig-cap: "Ραβδόγραμμα κλάδων απασχόλης πελατών της τράπεζας"

univariateQualitativePlot(bank_dataset, job, 
                          title = "Τομέας απασχόλησης του ερωτώμενων", 
                          subtitle = "Καθαρός αριθμός και ποσοστό (%) επί όλων των πελατών")
```

Άλλο ένα διαθέσιμο στοιχείο είναι η οικογενειακή κατάσταση καθώς μπορεί να συνδέεται με αυξημένες ανάγκες και έξοδα για το νοικοκυριό. Ενδεχομένως, ένας πελάτης που είναι παντρεμένο να έχει αυξημένα έξοδα για το νοικοκυριό του (π.χ. λόγω παιδιών). Άλλη μία οπτική θα ήταν . Γενικά, δεν είναι ξεκάθαρη εκ των προτέρων η ερμηνεία του συγκεκριμένου δείκτη. Σε κάθε περίπτωση στο υπό εξέταση δείγμα έχουμε περί το 60% των ατόμων που είναι παντρεμένοι, το ένα τέταρτο των πελατών είναι ανύπαντροι και οι υπόλοιποι είναι διαζευγμένοι.

```{r}
#| label: fig-marital
#| title: "Διάγραμμα: Οικογενειακή Κατάσταση"
#| fig-align: center
#| fig-cap: "Κυκλικό διάγραμμα οικογενειακής κατάστασης πελατών τράπεζας"

univariateQualitativePlot(bank_dataset, marital, 
                          title = "Ποια είναι η οικογενειακή σου κατάσταση;", 
                          subtitle = "Οι περισσότεροι είναι παντρεμένοι.",
                          "pie")
```


Ένας δείκτης που, τουλάχιστον διαισθητικά, μπορεί να είναι από τους πιο σημαντικούς είναι το ανώτατο επίπεδο εκπαίδευσης του πελάτη. Είναι λογικό κάποιος που έχει υψηλότερου επιπέδου σπουδές να έχει τη δυνατότητα να απασχοληθεί σε εργασίες που απαιτούν εξειδίκευση η οποία να πληρώνεται αντίστοιχα της μειωμένης προσφοράς. Άρα έμμεσα μπορεί να καθορίσει τις επαγγελματικές δυνατότητες του ενδιαφερόμενου και συνεπακόλουθα το μισθό που θα μπορεί να διεκδικεί και το ποσό που περισσεύσει για αποταμίευση. Στο συγκεκριμένο δείγμα μόλις το 30\% έχει πανεπιστημιακή εκπαίδευση.

```{r}
#| label: fig-educ
#| title: "Διάγραμμα: Επίπεδο εκπαίδευσης"
#| fig-align: center
#| fig-cap: "Ραβδόγραμμα εκπαιδευτικού υποβάθρου πελατών τράπεζας"

univariateQualitativePlot(bank_dataset, 
                          education, 
                          title = "Υψηλότερο επίπεδο εκπαίδευσης",
                          subtitle = "")
```

Έκτός όμως από τις σπουδές που είναι μία ισχυρή ένδειξη σημαντικό ρόλο στη δημιουργία μιας προθεσμιακής κατάθεσης είναι οι υποχρεώσεις του ατόμου. Αυτές μπορούν να διακριθούν μέσα από τρεις μεταβλητές που μας παρέχονται και πιο συγκεκριμένα αν:

- ο πελάτης έχει οφειλές
- ο πελάτης έχει λάβει κάποιο δάνειο (στεγαστικό / προσωπικό)

Είναι προφανές ότι αν έχει μη εξυπηρετούμενες οφειλές το τελευταίο πράγμα που θα σκεφτεί είναι να κάνει αποταμίευση, αλλά να ξεπληρώσει τα χρέη του. Στο δείγμα μόλις 76 άτομα που αντιστοιχούν στο 1.6\% των πελατών εμπίπτει σε αυτή τη κατηγορία, γεγονός που καθιστά να έχει νόημα η πρόταση για τη συντριπτική πλειοψηφία.

```{r}
#| label: fig-default
#| title: "Διάγραμμα: Πόσοι ερωτώμενοι έχουν οφειλές"
#| fig-align: center
#| fig-cap: "Κυκλικό διάγραμμα πελατών τράπεζας αναλόγως του αν εξυπηρετούν τις οφειλές του ή όχι"


univariateQualitativePlot(bank_dataset, default, 
                          title = "Έχετε μη εξυπηρετούμενες οφειλές;", 
                          subtitle = "Ποσοστό (%) ατόμων που δεν έχουν εκπληρώσει τις πιστωτικές τους υποχρεώσεις",  
                          "pie")

```

Επιπλέον, σημαντικό ποσοστό των πελατών της τράπεζας έχουν ήδη σημαντικές υποχρεώσεις τόσο σε βραχυπρόθεσμο επίπεδο, όσο και μακροπρόθεσμα. Πάνω από τους μισούς έχουν λάβει στεγαστικό δάνειο που σημαίνει μία πάγια σταθερή και σε βάθος χρόνου υποχρέωση η οποία δεν πρέπει να αθετηθεί μιας και πολλές φορές συνδυάζεται με υποθήκη του ακινήτου για το οποίο έλαβε και το δάνειο. Από την άλλη βέβαια θα μπορούσε να θεωρηθεί ότι με αυτό το τρόπο έχει προυπολογίσει το νοικοκυριό το κόστος της στέγασής τους και υπερτερεί της επιλογής του ενοικίου. Αυτό που κατά τη γνώμη μου ίσως να αποτελεί σημαντικότερο παράγοντα άρνησης είναι η λήψη καταναλωτικών δανείων. Αυτά τα δάνεια προορίζονται συνήθως για τη κάλυψη βραχυπρόθεσμων - έκτακτων αναγκών και αυτό το χρηματοδοτικό προιόν είναι διαβόητο για τα υψηλά επιτόκια καθιστώντας το μία ακιρβή επιλογή. Έτσι λοιπόν η αποπληρωμή του ίσως είναι το πρώτο πράγμα που θα πρέπει να κάνει κάποιος και προφανώς το άνοιγμα ενός προθεσμιακού λογαριασμού δεν είναι λογική. Στη δική μας περίπτωση περίπου το 15\% έχει λάβει καταναλωτικό δάνειο γεγονός που είναι ελαφρώς αισιόδοξο μιας και μας επιτρέπει να έχουμε βάσιμες ελπίδες εύρεσης ενδιαφερόμενων στο υπόλοιπο 85\%.

```{r}
#| label: fig-housing-personal-loan
#| fig-cap: 
#|   - "Κυκλικό διάγραμμα ατόμων που έχουν λάβει στεγαστικό δάνειο"
#|   - "Κυκλικό διάγραμμα ατόμων αναλόγως αν έχουν λάβει καταναλωτικό δάνειο"
#| layout-ncol: 2

univariateQualitativePlot(bank_dataset, housing, 
                          title = "Έχετε λάβει στεγαστικό δάνειο;", 
                          subtitle = "Ποσοστό (%) ατόμων που έχει λάβει στεγαστικό δάνειο",                            "pie")

univariateQualitativePlot(bank_dataset, loan, 
                          title = "Έχετε λάβει καταναλωτικό δάνειο;", 
                          subtitle = "Ποσοστό (%) ατόμων που έχει λάβει προσωπικό - καταναλωτικό δάνειο",                            "pie")
```


Ένα άλλο στοιχείο που δίνεται είναι το μέσο επικοινωνίας με τον πελάτη της τράπεζας. Πάνω από τους μισούς έχουν σταθερό τηλέφωνο ως μέσο επικοινωνίας.

```{r}
#| label: fig-contact
#| title: "Διάγραμμα: Μέσο επικοινωνίας"
#| fig-cap: "Κυκλικό διάγραμμα τρόπων προσέγγισης ατόμων - πελατών"
univariateQualitativePlot(bank_dataset, contact, 
                          title = "Μέσο επικοινωνίας", 
                          subtitle = "Η προώθηση μέσω κινητού είναι πιο εκτεταμένη σε σχέση με το σταθερό",
                          "pie")

```
Άλλη μία ενδιαφέρουσα μεταβλητή είναι ο τελευταίος μήνας στον οποίο προσεγγίστηκε ένας πελάτης. Οι περισσότερες τελευταίες προσεγγίσεις φαίνεται να έγιναν καλοκαιρινούς μήνες. Βέβαια αυτό το στοιχείο θέλει προσοχή στην ερμηνεία του γιατί μπορεί η λήψη των δεδομένων να έγινε π.χ. τον Σεπτέμβριο και τότε να είναι λογικό οι τελευταίες προσεγγίσεις να έγιναν τους καλοκαιρινούς μήνες. Ενδεχομένως να χρειαστεί διμεταβλητή ανάλυση στην επόμενη ενότητα σχετικά με τις επιτυχίες ανά μήνα, προκειμένου να εξεταστεί με μεγαλύτερη ακρίβεια ο συγκεκριμένος δείκτης.

```{r}
#| label: fig-last-month
#| title: "Διάγραμμα: Μήνας τελευταίας προσέγγισης"
#| fig-cap: "Κυκλικό διάγραμμα τρόπων προσέγγισης ατόμων - πελατών"
univariateQualitativePlot(bank_dataset, month, 
                          title = "Μέσο επικοινωνίας", 
                          subtitle = "Η προώθηση μέσω κινητού είναι πιο εκτεταμένη σε σχέση με το σταθερό")
```

Σύμφωνα με τα δεδομένα και τη περιγραφή των δεδομένων η τράπεζα θα είχε τρέξει και σε προηγούμενα χρόνια παρόμοιες καμπάνιες ενημέρωσης και πρώθησης τραπεζικών προϊόντων και συγκεκριμένα προθεσμιακών λογαριασμών. Έτσι λοιπόν, έχουμε δεδομένα για όσους είχαν αποδεχτεί άνοιγμα λογαριασμού σε προηγούμενα χρόνια το οποίο μπορεί να είναι αρκετά βοηθητικό και ενδεχομένως μεγάλο ποσοστό να έχει νόημα να επανεγγραφεί. Ως αποτέλεσματ των προηγούμενων καμπάνιων είχαμε 129 ενδιαφερόμενους για κλειστούς λογαριασμούς, ενώ η κατάσταση πολλών είναι άγνωστη για τις προηγούμενες καμπάνιες.


```{r}
#| label: fig-poutcome
#| title: "Διάγραμμα: Απόκριση ατόμου σε προηγούμενες καμπάνιες"
#| fig-cap: "Κυκλικό διάγραμμα απόκρισης των ατόμων σε προηγούμενες καμπάνιες προώθησης προθεσμιακών λογαριασμών"
univariateQualitativePlot(bank_dataset, poutcome, 
                          title = "Ποιο ήταν το αποτέλεσμα προηγούμενης προσέγγισης?", 
                          subtitle = "For every five failed approaches there was one succussful.", "pie")
```


Εδώ στην ουσία έχω το αποτέλεσμα το οποίο προσπαθώ να προβλέψω. Αυτά τα δεδομένα είναι γνωστά από τη τωρινή καμπάνια. Με βάση όμως αυτά τις προηγούμενες μεταβλητές - χαρακτηριστικά θα κατασκευάσω ένα μοντέλο πρόβλεψης και αυτά τα μοντέλα θα αξιολογηθούν με βάση αυτά τα δοσμένα αποτελέσματα. 

```{r}
#| label: fig-outcome
#| title: "Διάγραμμα: Απόκριση ατόμου σε τωρινή προσέγγιση"
#| fig-cap: "Κυκλικό διάγραμμα απόκρισης των ατόμων στη τωρινή καμπάνια προώθησης προθεσμιακών λογαριασμών"
univariateQualitativePlot(bank_dataset, y, 
                          title = "Πόσοι αποφάσισαν να φτιάξουν προθεσμιακό λογαριασμό;", 
                          subtitle = "Ποσοστό πελατών που αποφάσισαν να ανοίξουν
                          έναν προθεσμιακό λογαριασμό ως αποτέλεσμα της τωρινής καμπάνιας.",
                          "pie")
```

Οι καταθέτες της τράπεζας είναι κυρίως νεότερης ηλικίας και η συντριπτική πλειοψηφία κάτω των 60 ετών. Το ιστόγραμμα φαίνεται να έχει ένα σχήμα καμπάνας που προσοιδιάζει στη κανονική κατανομή, αλλά υπάρχει μία ελαφριά θετική ασυμμετρία.

```{r}
#| label: fig-age
#| title: "Διάγραμμα: Ηλικία ερωτώμενου"
#| fig-cap: "Ιστόγραμμα κατανομής ηλικιών πελατών τράπεζας"
hchart(bank_dataset$age) %>%
    hc_title(text = "Κατανομή ηλικιών") %>%
    hc_subtitle(text = glue("Η διάμεση ηλικία είναι τα <b>{median(bank_dataset$age)}</b> έτη.")) %>%
    hc_caption(text = "Bank Marketing Dataset from UCI") %>%
    hc_tooltip(pointFormat = "{point.name}: {point.y}") %>%
    hc_legend(enabled = FALSE)
```


```{r}
#| label: fig-balance
#| title: "Διάγραμμα υπόλοιπου λογαριασμού"
#| fig-cap: "Ιστόγραμμα κατανομής ηλικιών πελατών τράπεζας"
hchart(bank_dataset$balance) %>%
    hc_title(text = "Κατανομή καταθέσεων") %>%
    hc_subtitle(text = glue("Οι περισσότερες καταθέσεις κυμαίνονται μεταξύ των 0$ και 200$ δολαρίων. Το διάμεσο υπόλοιπο λογαριασμού είναι {median(bank_dataset$balance)} $. Το 75ο τεταρτημόριο είναι τα 1480$, άρα το ένα τέταρτο των πελατών έχει καταθέσεις υψηλότερες αυτού του ποσού. Τα ύψη των λογαριασμών κυμαίνονται από {min(bank_dataset$balance)} μέχρι και τα {max(bank_dataset$balance)} $")) %>%
    hc_caption(text = "Bank Marketing Dataset from UCI") %>%
    hc_tooltip(pointFormat = "{point.name}: {point.y}") %>%
    hc_legend(enabled = FALSE) %>%
    hc_xAxis(
    title = list(text = "Ύψος καταθέσεων σε δολαρια ΗΠΑ $"),
      max = 10000
)
```

Άλλο ένα στοιχείο είναι η διάρκεια της κλήσης. Διαισθητικά, αν η κλήση διαρκεί πολύ λίγο πιθανότατα να σημαίνει ότι ο πελάτης δεν ενδιαφέρεται. Σε αντίθετη περίπτωση 

```{r}
#| label: fig-call-duration
#| title: "Διάγραμμα: Διάρκεια κλήσης"
#| fig-cap: "Ιστόγραμμα συνολικής διάρκειας κλήσης (σε δευτερόλεπτα)"
hchart(bank_dataset$duration) %>%
    hc_title(text = "Διάρκεια κλήσης") %>%
    hc_subtitle(text = glue("Οι περισσότερες καταθέσεις κυμαίνονται μεταξύ των 0$ και 200$ δολαρίων. Το διάμεσο υπόλοιπο λογαριασμού είναι {median(bank_dataset$balance)} $. Το 75ο τεταρτημόριο είναι τα 1480$, άρα το ένα τέταρτο των πελατών έχει καταθέσεις υψηλότερες αυτού του ποσού. Τα ύψη των λογαριασμών κυμαίνονται από {min(bank_dataset$balance)} μέχρι και τα {max(bank_dataset$balance)} $")) %>%
    hc_caption(text = "Bank Marketing Dataset from UCI") %>%
    hc_tooltip(pointFormat = "{point.name}: {point.y}") %>%
    hc_legend(enabled = FALSE) %>%
    hc_xAxis(
    title = list(text = "Διάρκεια κλήσης (σε δευτερόλεπτα)"),
    max = 1000)
```



```{r}
#| label: recoding_campaign_variable
#| title: "Επανακωδικοποίηση: Προσεγγίσεις σε αυτή τη καμπάνια"
s = bank_dataset %>%
  mutate(category = case_when(
    campaign >= 1 & campaign <= 7 ~ as.character(campaign),
    campaign > 7              ~ "8+",
    TRUE                   ~ NA_character_
  )) %>%
  mutate(category = factor(category, levels = c(as.character(1:7), "8+"), ordered = TRUE))

```

```{r}
#| label: fig-times-of-promoting
#| title: "Διάγραμμα: Αριθμός προσεγγίσεων ενός πελάτη"
#| fig-cap: "Ραβδόγραμμα αριθμού συνολικών προσεγγίσεων - επικοινωνιών που έγιναν σε έναν πελάτη"
hchart(s$category) %>%
    hc_title(text = "Αριθμός προσεγγίσεων") %>%
    hc_subtitle(text = glue("Οι περισσότερες καταθέσεις κυμαίνονται μεταξύ των 0€ και 200€ ευρώ. Το διάμεσο υπόλοιπο λογαριασμού είναι {median(bank_dataset$balance)} €. Το 75ο τεταρτημόριο είναι τα 1480€, άρα το ένα τέταρτο των πελατών έχει καταθέσεις υψηλότερες αυτού του ποσού. Τα ύψη των λογαριασμών κυμαίνονται από {min(bank_dataset$balance)} μέχρι και τα {max(bank_dataset$balance)} $")) %>%
    hc_caption(text = "Bank Marketing Dataset from UCI") %>%
    hc_legend(enabled = FALSE) %>%
    hc_xAxis(
    title = list(text = "Ύψος καταθέσεων σε ευρώ €")
)
```

### Διμεταβλητή ανάλυση



```{r}
plotjob <- bank_dataset %>%
  group_by(job, y) %>%
  summarize(n = n()) %>% 
  mutate(pct = round(100*(n/sum(n)), digits = 1),
         lbl = scales::percent(pct)) %>%
  arrange(desc(pct))

highchart() %>%
  hc_chart(type = "column") %>%
  hc_xAxis(categories = plotjob$job) %>%
  hc_yAxis(
    min = 0,
    max = 100,
    title = list(text = "Percentage"),
    labels = list(format = "{value}%")
  ) %>%
  hc_plotOptions(
    column = list(
      stacking = "percent",
      dataLabels = list(
        enabled = TRUE,
        format = "{point.y:.0f}%"
      )
    )
  ) %>%
  hc_series(
    list(name = "Όχι", data = plotjob$pct[plotjob$y == "όχι"], color = "#FF5733"),
    list(name = "Ναι", data = sort(plotjob$pct[plotjob$y == "ναι"]), color = "#33FF57")
  ) %>%
  hc_tooltip(pointFormat = "<b>{series.name}</b>: {point.y}%") %>%
  hc_title(text = "Job of Respondent by Interest to Term Deposit") %>%
  hc_subtitle(text = "Students and retirees are the population groups with a proportionally lower interest in term deposits compared to other groups.") %>%
  hc_responsive(
    rules = list(
      list(
        condition = list(
          maxWidth = 500 # Hide labels when screen width is ≤500px
        ),
        chartOptions = list(
          plotOptions = list(
            column = list(
              dataLabels = list(enabled = FALSE) # Disable labels
            )
          )
        )
      )
    )
)
```



## Κατασκευή μοντέλου

Στην R υπάρχουν υπάρχουν δύο αρκετά διαδεδομένοι τρόποι για τη κατασκευή
μοντέλων, το [caret](https://topepo.github.io/caret/) και το
[tidymodels](https://www.tidymodels.org/). Από τη μία μεριά, το πακέτο caret
είναι αρκετά εύκολο στη χρήση, υπάρχουν αρκετά άρθα σχετικά με αυτό όπως
οδηγοί - tutorials, επεξηγηματικά βίντεο - άρθρα. Από την άλλη μεριά, το
tidymodels είναι μία \<<όλα σε ένα>\> λύση μιας και αποτελεί ένα μεταπακέτο,
δηλαδή μία συλλογή πακέτων, που προσπαθεί να δώσει , ωστόσο υπάρχει λιγότερη
τεκμηρίωση και άρθρα μιας και έχει δημιουργηθεί αρκετά πρόσφατα.

### Διαχωρισμός συνόλου δεδομένων

Το πρώτο βήμα είναι να χωρίσουμε το αρχικό σύνολο δεδομένων σε δύο μέρη, όπου το
καθένα θα χρησιμοποιηθεί για ένα ξεχωριστό σκοπό. Το πρώτο υποσύνολο
χρησιμοποιείται για να εκπαιδεύσω - κατασκευάσω το μοντέλο μου, ενώ το δεύτερο
μέρος (test dataset) είναι αναγκαίο ώστε να ελέγξουμε την ακρίβεια του μοντέλου
που προέκυψε από το πρώτο υποσύνολο.

```{r}
#| label: split_data_train_test
#| title: "Διαχωρισμός συνόλου δεδομένων"
set.seed(123)
bank_dataset_split <- initial_split(bank_dataset,
                                prop = 0.75,
                                strata = y)

# Create training data
bank_train <- bank_dataset_split %>%
                    training()

# Create testing data
bank_test <- bank_dataset_split %>%
                    testing()
```

<center>

```{mermaid}
%%| echo: false
%%| title: "Σχεδιάγραμμα: Διαχωρισμός δεδομένων"
%%| label: fig-diagram-split
%%| fig-cap: "Διαχωρισμός δεδομένων σε δύο μέρη (για εκπαίδευση και έλεγχο απόδοσης του μοντέλου)"

graph TD;
  A(Σύνολο δεδομένων <br> 4521 παρατηρήσεις) --> B(Σύνολο εκπαίδευσης <br> 3390 παρατηρήσεις)
  A(Σύνολο δεδομένων <br> 4521 παρατηρήσεις) --> C(Σύνολο αξιολόγησης <br> 1131 παρατηρήσεις)
```

</center>

Στο δικό μας παράδειγμα, έχουμε όπως αναφέραμε προηγούμενως 4521 παρατηρήσεις. Η
πιο συνήθης είναι ο διαχωρισμός να γίνεται σε ένα ποσοστό 75% (80%) για να
εκπαιδεύσω το μοντέλο μου και το άλλο 25% (20%) για την αξιολόγηση αυτού. Έτσι
λοιπόν, καταλήγω με δύο νέα υποσύνολα με τον ίδιο αριθμό μεταβλητών, και το
σύνολο εκπαίδευσης του μοντέλου αποτελείται από 3390 παρατηρήσεις και το σύνολο
για την αξιολόγησή του αποτελείται από 1131.

#### Δεδομένα εκπαίδευσης

```{r}
#| label: tbl-preview-train-dataset
#| title: "Προεπισκόπηση δεδομένων εκπαίδευσης"
#| tbl-cap: "Προεπισκόπηση υποσυνόλου δεδομένων εκπαίδευσης μοντέλου (train dataset)"
reactable(
  head(bank_train, 5),
  bordered = FALSE,     # No borders (booktabs style)
  striped = FALSE,      # No stripes for a clean look
  highlight = FALSE,    # No hover highlighting
  defaultColDef = colDef(align = "center"),
  style = list(fontSize = "14px", border = "none"),
  theme = reactableTheme(
    borderColor = "transparent", # Remove border
    cellStyle = list(
      borderBottom = "transparent"  # Subtle line between rows
    ),
    headerStyle = list(
      borderBottom = "2px solid rgb(117, 117, 117)", # Thick top rule
      borderTop = "2px solid rgb(117, 117, 117)",
      fontWeight = "bold"
    )
  )
) 
```

#### Δεδομένα αξιολόγησης

```{r}
#| label: tbl-preview-test-dataset
#| title: "Προεπισκόπηση δεδομένων αξιολόγησης"
#| tbl-cap: "Προεπισκόπηση υποσυνόλου δεδομένων αξιολόγησης μοντέλου (test dataset)"

reactable(
  head(bank_test, 5),
  bordered = FALSE,     # No borders (booktabs style)
  striped = FALSE,      # No stripes for a clean look
  highlight = FALSE,    # No hover highlighting
  defaultColDef = colDef(align = "center"),
  style = list(fontSize = "14px", border = "none"),
  theme = reactableTheme(
    borderColor = "transparent", # Remove border
    cellStyle = list(
      borderBottom = "transparent"  # Subtle line between rows
    ),
    headerStyle = list(
      borderBottom = "2px solid rgb(117, 117, 117)", # Thick top rule
      borderTop = "2px solid rgb(117, 117, 117)",
      fontWeight = "bold"
    )
  )
) 
```

### Επεξεργασία δεδομένων

Βέβαια η κατασκευή των μοντέλων δεν είναι τόσο εύκολη υπόθεση. Ανάμεσα στο
διαχωρισμό του συνόλου δεδομένων και τη κατασκευή των μοντέλων παρεμβάλεται η
επεξεργασία των δεδομένων. Τα βήματα αυτού του σταδίου δεν είναι δεδομένα και
ποικίλουν αναλόγως το είδος του προβλήματος (ταξινόμησης ή πρόβλεψης τιμής) αλλά
και το ποιο μοντέλο θα επιλέξω. Ευτυχώς, για εμάς το πακέτο `tidymodels`
προσφέρει έτοιμες εντολές προκειμένου να κάνει ανάλυσή μας ευκολότερη και
ιδιαίτερα εντολές του πακέτου recipes, που αποτελούν μέρος του tidymodels
μπορούν να φανούν ιδιαίτερα χρήσιμες σε αυτό το στάδιο. Βέβαια, υπάρχουν και
άλλα πακέτα που συμπληρώνουν - λύνουν συνήθη προβλήματα στα δεδομένα. Για
παράδειγμα, στα δεδομένα μας αναμένεται και είδαμε και στο παραπάνω σχήμα ότι οι
περισσότεροι δεν επιθυμούν να ανοίξουν προθεσμιακό λογιαριασμό. Τα δεδομένα μας
χαρακτηρίζονται ως ανισσόροπα (imbalanced) όταν η μεταβλητή την οποία προσπαθώ
να προβλέψω δεν έχω επαρκείς τιμές αλλά αρκετά μεγάλη διαφορά (90% δεν επιθυμούν
/ 10%) Σε αυτή τη περίπτωση μπορώ να χρησιμοποιήσω την εντολή `step_smote()` από
το πακέτο *themis*, προκειμένου να ισορροπήσω τη μεταβλητή που προσπαθώ να
προβλέψω.

```{r}
#| label: building_recipe
#| title: "Επεξεργασία δεδομένων"
bank_recipe <- recipes::recipe(y~., 
                               data = bank_train) %>%
  step_rm(poutcome, ID) %>%
  step_corr(all_numeric(), threshold = 0.75) %>%
  step_dummy(all_nominal(), -all_outcomes()) %>%
  step_smote(y)
```

Ας ρίξουμε τώρα μία ματιά στο σύνολο δεδομένων, αφού κάναμε κάποια βασική
επεξεργασία των δεδομένων:

```{r Προεπισκόπηση δεδομένων με εφαρμογή οδηγιών επεξεργασίας}
#| label: tbl-recipes-df-after-recipes
#| tbl-cap: "Σύνολο δεδομένων με εφαρμογή των `recipes`"
#| tbl-cap-location: top

bank_recipe %>%
  prep() %>%
  juice() %>%
  head() %>%
  reactable(.,
  bordered = FALSE,     # No borders (booktabs style)
  striped = FALSE,      # No stripes for a clean look
  highlight = FALSE,    # No hover highlighting
  defaultColDef = colDef(align = "center"),
  style = list(fontSize = "14px", border = "none"),
  theme = reactableTheme(
    borderColor = "transparent", # Remove border
    cellStyle = list(
      borderBottom = "transparent"  # Subtle line between rows
    ),
    headerStyle = list(
      borderBottom = "2px solid rgb(117, 117, 117)", # Thick top rule
      borderTop = "2px solid rgb(117, 117, 117)",
      fontWeight = "bold"
    )
  )
) 
```

### Διασταυρωμένη επικύρωση

> Οκ, ήρθε η ώρα να κατασκευάσουμε το μοντέλο μας;

Όχι τόσο γρήγορα. Θεωρητικά θα μπορούσαμε να συνεχίσουμε, ωστόσο η ενδεδειγμένη
μέθοδος είναι να μην λαμβάνω απλώς δύο μέρη καθώς η περαιτέρω αξιολογηση
βασίζεται ως επί το πλείστον στο πώς έγινε ο διαχωρισμός και ποιες τιμές
λήφθηκαν. Για να έχουμε μία πιο ακριβή εκτίμηση της απόδοσης του μοντέλου
προτείνετε να κατασκευάσουμε υποσύνολα των δεδομένων μου με σκοπό να βρω τις
παραμέτρους οι οποίες οδηγούν συστηματικά, κατά μέσο όρο σε 5 ή 10 υπό-δείγματα
σε καλύτερη ακρίβεια.

```{r}
#cv_folds <- vfold_cv(v = 5, strata = y)
```

### Κατασκευάζοντας το μοντέλο μου

Στη συνέχεια, με το πακέτο parsnip μπορώ να ορίσω τα χαρακτηριστικά των διάφορων
μοντέλων που θέλω να κατασκευάσω. Στη συγκεκριμένη περίπτωση θα ήθελα να ελέγξω
διάφορα μοντέλα και αν ελέγξω την απόδοσή τους. Επομένως, θα ορίσω μοντέλα:

-   k Κοντινότερων Γειτόνων (k - Nearest Neighbors)
-   Λογιστική Παλινδρόμηση (Logistic Regression)
-   Naive Bayes
-   Τυχαίου δάσους (Random Forest)
-   LightGBM

Next, parsnip helps us to specify our models. Initially, I will define a
LightGBM model,

```{r}
#| label: define_lightgbm_model
#| title: "Ορισμός μοντέλου LightGBM"
lightgbm_model<- parsnip::boost_tree(
 mode = "classification",
 trees = 50,
 min_n = tune(),
 learn_rate = tune(),
 tree_depth = tune()) %>%
set_engine("lightgbm")
```
