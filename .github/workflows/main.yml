name: Render babelquarto (quarto) website

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      RENV_PATHS_ROOT: ~/.cache/R/renv

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # --- Quarto Setup
      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: pre-release

      # --- System libraries
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev libfribidi-dev libharfbuzz-dev libxslt1-dev \
            libblas-dev liblapack-dev libpoppler-cpp-dev libfontconfig1-dev \
            libcairo2-dev libfreetype6-dev libpng-dev libtiff5-dev \
            libjpeg-dev pkg-config libglpk-dev libsecret-1-dev libxml2-dev libssl-dev

      # --- R setup
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: "4.5.2"
          use-public-rspm: true

      # --- Java for rJava
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Configure Java for rJava
        run: sudo R CMD javareconf

      # --- renv cache
      - name: Restore renv packages
        uses: r-lib/actions/setup-renv@v2
        with:
          cache-version: 1

      # --- Render Quarto site
      - name: Render website
        run: Rscript -e 'babelquarto::render_website()'
        env:
          BABELQUARTO_CI_URL: https://stesiam.com

      # --- Sanity check
      - name: Verify site output
        run: |
          test -f docs/index.html || {
            echo "‚ùå docs/index.html not found"
            exit 1
          }

      # --- NEW: PURGECSS OPTIMIZATION ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run PurgeCSS
        run: |
          npm install -g purgecss
          
          BOOTSTRAP_FILES=$(find docs -name "bootstrap.min.css")

          if [ -z "$BOOTSTRAP_FILES" ]; then
            echo "‚ö†Ô∏è No bootstrap.min.css files found in docs/. Skipping."
            exit 0
          fi

          for CSS_FILE in $BOOTSTRAP_FILES; do
            echo "Processing: $CSS_FILE"
            
            purgecss --css "$CSS_FILE" \
                     --content "docs/**/*.html" "docs/**/*.js" \
                     --safelist "show" "collapsing" "collapse" "navbar-toggler" "quarto-search" "quarto-search-results" "quarto-secondary-nav" \
                     --output "$CSS_FILE"
          done

      - name: Verify Results
        run: |
          echo "Final CSS sizes:"
          find docs -name "bootstrap.min.css" -exec ls -lh {} +

      # --- Upload Pages artifact
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./docs

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages üöÄ
        id: deployment
        uses: actions/deploy-pages@v4
